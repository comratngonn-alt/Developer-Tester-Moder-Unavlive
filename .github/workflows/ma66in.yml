name: Truy C·∫≠p T·ª´ Xa Windows Server 2022

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-2022
    timeout-minutes: 3600

    steps:
      - name: ‚öôÔ∏è C·∫•u H√¨nh RDP v√† T∆∞·ªùng L·ª≠a Windows
        run: |
          Write-Host "K√≠ch ho·∫°t Remote Desktop v√† m·ªü c·ªïng T∆∞·ªùng L·ª≠a..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Inbound"
          netsh advfirewall firewall add rule name="RDP-Inbound" `
            dir=in action=allow protocol=TCP localport=3389
          Write-Host "C·∫•u h√¨nh RDP ho√†n t·∫•t."

      - name: üîê T·∫°o Ng∆∞·ªùi D√πng Admin123 v√† M·∫≠t Kh·∫©u B·∫£o M·∫≠t
        run: |
          $RDP_USER = "Admin123"
          Write-Host "B·∫Øt ƒë·∫ßu t·∫°o ng∆∞·ªùi d√πng $RDP_USER..."
          
          # Logic t·∫°o m·∫≠t kh·∫©u ng·∫´u nhi√™n v√† b·∫£o m·∫≠t
          Add-Type -AssemblyName System.Security
          $charSet = @{ Upper=[char[]](65..90); Lower=[char[]](97..122); Number=[char[]](48..57); Special=([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126)) }
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random -Count 16 })
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          New-LocalUser -Name $RDP_USER -Password $securePass -AccountNeverExpires
          
          Add-LocalGroupMember -Group "Administrators" -Member $RDP_USER
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $RDP_USER
          
          echo "RDP_USER=$RDP_USER" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          Write-Host "T·∫°o ng∆∞·ªùi d√πng v√† ƒë·∫∑t m·∫≠t kh·∫©u b·∫£o m·∫≠t ho√†n t·∫•t. User: $RDP_USER"

      - name: ‚¨áÔ∏è C√†i ƒê·∫∑t Tailscale (S·ª≠ d·ª•ng URL m·ªõi)
        run: |
          Write-Host "T·∫£i v√† c√†i ƒë·∫∑t Tailscale ƒë·ªÉ t·∫°o k·∫øt n·ªëi b·∫£o m·∫≠t..."
          
          # C·∫¨P NH·∫¨T: D√πng URL t·∫£i xu·ªëng phi√™n b·∫£n ·ªïn ƒë·ªãnh m·ªõi nh·∫•t
          # ƒê√¢y l√† URL ch√≠nh th·ª©c t·ª´ Tailscale, hy v·ªçng s·∫Ω kh·∫Øc ph·ª•c l·ªói "Not Found"
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-x64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Write-Host "ƒêang t·∫£i Tailscale t·ª´ $tsUrl..."
          
          # T·∫£i xu·ªëng (b∆∞·ªõc n√†y b·ªã l·ªói tr∆∞·ªõc ƒë√≥)
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          
          Write-Host "T·∫£i xu·ªëng th√†nh c√¥ng. B·∫Øt ƒë·∫ßu c√†i ƒë·∫∑t..."
          
          # C√†i ƒë·∫∑t
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
          Write-Host "C√†i ƒë·∫∑t Tailscale ho√†n t·∫•t."

      - name: üîó Thi·∫øt L·∫≠p K·∫øt N·ªëi Tailscale
        run: |
          Write-Host "K·∫øt n·ªëi v·ªõi Tailnet c·ªßa b·∫°n..."
          $TS_EXE = "$env:ProgramFiles\Tailscale\tailscale.exe"
          
          # Ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa file exe tr∆∞·ªõc khi ch·∫°y
          if (-not (Test-Path $TS_EXE)) {
              Write-Error "L·ªói: Kh√¥ng t√¨m th·∫•y Tailscale.exe t·∫°i $TS_EXE. Qu√° tr√¨nh c√†i ƒë·∫∑t c√≥ th·ªÉ ƒë√£ th·∫•t b·∫°i."
              exit 1
          }

          # S·ª≠ d·ª•ng Auth Key ƒë·ªÉ k√≠ch ho·∫°t Tailscale
          & "$TS_EXE" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=win2022-rdp-$env:GITHUB_RUN_ID --ssh
          
          # ƒê·ª£i Tailscale g√°n IP
          $tsIP = $null
          $retries = 0
          Write-Host "ƒêang ch·ªù Tailscale g√°n ƒë·ªãa ch·ªâ IP..."
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$TS_EXE" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          
          if (-not $tsIP) {
              Write-Error "L·ªói: Tailscale kh√¥ng g√°n ƒë∆∞·ª£c ƒë·ªãa ch·ªâ IP. Vui l√≤ng ki·ªÉm tra Auth Key."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "ƒê√£ g√°n IP th√†nh c√¥ng: $tsIP"
      
      - name: üõë Duy Tr√¨ K·∫øt N·ªëi v√† Hi·ªÉn Th·ªã Th√¥ng Tin Truy C·∫≠p
        run: |
          Write-Host "`n=== TH√îNG TIN TRUY C·∫¨P RDP ==="
          Write-Host "H·ªá ƒêi·ªÅu H√†nh: Windows Server 2022"
          Write-Host "ƒê·ªãa Ch·ªâ (Tailscale IP): $env:TAILSCALE_IP"
          Write-Host "T√™n Ng∆∞·ªùi D√πng: $env:RDP_USER"
          Write-Host "M·∫≠t Kh·∫©u (B·∫£o m·∫≠t): $env:RDP_PASSWORD"
          Write-Host "============================`n"
          
          # V√≤ng l·∫∑p v√¥ h·∫°n ƒë·ªÉ gi·ªØ cho Runner ho·∫°t ƒë·ªông
          while ($true) {
              Write-Host "[$(Get-Date)] RDP ƒëang ho·∫°t ƒë·ªông - Vui l√≤ng d√πng Ctrl+C trong workflow ƒë·ªÉ k·∫øt th√∫c."
              Start-Sleep -Seconds 300
          }
