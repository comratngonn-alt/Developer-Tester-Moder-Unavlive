name: Truy C·∫≠p T·ª´ Xa Windows Server 2022

on:
  # K√≠ch ho·∫°t th·ªß c√¥ng t·ª´ giao di·ªán GitHub Actions
  workflow_dispatch:

jobs:
  secure-rdp:
    # S·ª≠ d·ª•ng Windows Server 2022 Runner
    runs-on: windows-2022
    # ƒê·∫∑t th·ªùi gian timeout t·ªëi ƒëa 6 gi·ªù (3600 ph√∫t)
    timeout-minutes: 3600

    steps:
      - name: ‚öôÔ∏è C·∫•u H√¨nh RDP v√† T∆∞·ªùng L·ª≠a Windows
        run: |
          Write-Host "K√≠ch ho·∫°t Remote Desktop v√† m·ªü c·ªïng T∆∞·ªùng L·ª≠a..."
          # B·∫≠t Remote Desktop b·∫±ng c√°ch ƒë·∫∑t fDenyTSConnections = 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          
          # X√≥a lu·∫≠t c≈© n·∫øu t·ªìn t·∫°i
          netsh advfirewall firewall delete rule name="RDP-Inbound"
          
          # M·ªü c·ªïng RDP (3389) qua T∆∞·ªùng L·ª≠a (Firewall)
          netsh advfirewall firewall add rule name="RDP-Inbound" `
            dir=in action=allow protocol=TCP localport=3389
          
          Write-Host "C·∫•u h√¨nh RDP ho√†n t·∫•t."

      - name: üîê T·∫°o Ng∆∞·ªùi D√πng Admin123 v√† M·∫≠t Kh·∫©u B·∫£o M·∫≠t
        run: |
          $RDP_USER = "Admin123"
          Write-Host "B·∫Øt ƒë·∫ßu t·∫°o ng∆∞·ªùi d√πng $RDP_USER..."
          
          # Logic t·∫°o m·∫≠t kh·∫©u ng·∫´u nhi√™n v√† b·∫£o m·∫≠t (t·ªëi thi·ªÉu 16 k√Ω t·ª±)
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = [char[]](65..90)      
              Lower   = [char[]](97..122)     
              Number  = [char[]](48..57)      
              Special = ([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126))
          }
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random -Count 16 })
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # T·∫°o ng∆∞·ªùi d√πng Admin123 v√† ƒë·∫∑t m·∫≠t kh·∫©u
          New-LocalUser -Name $RDP_USER -Password $securePass -AccountNeverExpires
          
          # Th√™m ng∆∞·ªùi d√πng v√†o nh√≥m Administrators (theo y√™u c·∫ßu)
          Add-LocalGroupMember -Group "Administrators" -Member $RDP_USER
          
          # Th√™m ng∆∞·ªùi d√πng v√†o nh√≥m Remote Desktop Users
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $RDP_USER
          
          # L∆∞u th√¥ng tin v√†o bi·∫øn m√¥i tr∆∞·ªùng
          echo "RDP_USER=$RDP_USER" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          Write-Host "T·∫°o ng∆∞·ªùi d√πng v√† ƒë·∫∑t m·∫≠t kh·∫©u b·∫£o m·∫≠t ho√†n t·∫•t. User: $RDP_USER"

      - name: üîó Thi·∫øt L·∫≠p K·∫øt N·ªëi Tailscale (S·ª≠ d·ª•ng Action ·ªïn ƒë·ªãnh)
        # Action n√†y t·ª± ƒë·ªông c√†i ƒë·∫∑t Tailscale v√† k·∫øt n·ªëi
        uses: tailscale/github-action@v2
        with:
          # Vui l√≤ng ƒë·∫£m b·∫£o b·∫°n ƒë√£ t·∫°o Secret TAILSCALE_AUTH_KEY
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }} 
          hostname: win2022-rdp-${{ github.run_id }}
          # K√≠ch ho·∫°t SSH (t√πy ch·ªçn)
          setup-ssh: true 

      - name: üõë Duy Tr√¨ K·∫øt N·ªëi v√† Hi·ªÉn Th·ªã Th√¥ng Tin Truy C·∫≠p
        run: |
          # Tailscale Action s·∫Ω ƒë·∫∑t IP v√†o bi·∫øn m√¥i tr∆∞·ªùng $env:TS_IP
          $tsIP = $env:TS_IP
          
          if (-not $tsIP) {
               Write-Host "C·∫£nh b√°o: Kh√¥ng t√¨m th·∫•y $env:TS_IP. Th·ª≠ l·∫•y IP b·∫±ng l·ªánh Tailscale..."
               # L·ªánh d·ª± ph√≤ng ƒë·ªÉ l·∫•y IP
               $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          }
          
          Write-Host "`n=== TH√îNG TIN TRUY C·∫¨P RDP ==="
          Write-Host "H·ªá ƒêi·ªÅu H√†nh: Windows Server 2022"
          Write-Host "ƒê·ªãa Ch·ªâ (Tailscale IP): $tsIP"
          Write-Host "T√™n Ng∆∞·ªùi D√πng: $env:RDP_USER"
          Write-Host "M·∫≠t Kh·∫©u (B·∫£o m·∫≠t): $env:RDP_PASSWORD"
          Write-Host "============================`n"
          
          # V√≤ng l·∫∑p v√¥ h·∫°n ƒë·ªÉ gi·ªØ cho Runner ho·∫°t ƒë·ªông
          while ($true) {
              Write-Host "[$(Get-Date)] RDP ƒëang ho·∫°t ƒë·ªông - K·∫øt n·ªëi b·∫±ng Microsoft Remote Desktop Client."
              Start-Sleep -Seconds 300
          }
